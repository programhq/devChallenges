    let character = document.getElementById("character");
    let character_css = character.currentStyle || window.getComputedStyle(character);

    document.onkeydown = function(evt) {
        evt = evt || window.event;

        if (evt.keyCode == 65) {
            current_left_margin = parseInt(character_css.marginLeft) - 10;
            if(current_left_margin < 0) { current_left_margin = 0; }
            character.style.marginLeft = current_left_margin + "px";
        }

        if (evt.keyCode == 68) {
            current_left_margin = parseInt(character_css.marginLeft) + 10;
            if(current_left_margin > 1230) { current_left_margin = 1230; }
            character.style.marginLeft = current_left_margin + "px";
        }
    };